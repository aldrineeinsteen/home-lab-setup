---
- name: Setup Pi-hole and Configure DHCP
  hosts: pihole_server
  become: yes
  vars_files:
    - ../.env.yaml

  tasks:
    # Wait until any background apt/unattended-upgrades finishes
    - name: Wait for apt/dpkg locks to be released
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock >/dev/null 2>&1; do
          sleep 3
        done
      changed_when: false

    # OPTIONAL: pause apt-daily during this play (re-enable later)
    - name: Stop apt-daily services/timers
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - apt-daily.service
        - apt-daily.timer
        - apt-daily-upgrade.service
        - apt-daily-upgrade.timer
      ignore_errors: true

    - name: Ensure prerequisites for installer
      ansible.builtin.apt:
        name:
          - curl
          - ca-certificates
        state: present
        update_cache: yes
        lock_timeout: 300
    
    - name: Ensure /etc/pihole directory exists
      ansible.builtin.file:
        path: /etc/pihole
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Preseed /etc/pihole/setupVars.conf for unattended install
      ansible.builtin.copy:
        dest: /etc/pihole/setupVars.conf
        mode: '0644'
        content: |
          PIHOLE_INTERFACE={{ pihole.interface }}
          IPV4_ADDRESS={{ pihole.machine_ip }}/24
          IPV6_ADDRESS=
          PIHOLE_DNS_1={{ pihole.upstream_1 | default('1.1.1.1') }}
          PIHOLE_DNS_2={{ pihole.upstream_2 | default('1.0.0.1') }}
          QUERY_LOGGING=true
          INSTALL_WEB_SERVER=true
          INSTALL_WEB_INTERFACE=true
          LIGHTTPD_ENABLED=true
          DNSMASQ_LISTENING=single
          BLOCKING_ENABLED=true
          WEBPASSWORD={{ pihole.admin_password | default('', true) }}

    - name: Install Pi-hole unattended (no TUI)
      ansible.builtin.shell: |
        curl -sSL https://install.pi-hole.net -o /tmp/install-pihole.sh
        bash /tmp/install-pihole.sh --unattended
      args:
        creates: /usr/local/bin/pihole
      environment:
        TERM: xterm
        DEBIAN_FRONTEND: noninteractive
        # Uncomment if your OS check complains:
        # PIHOLE_SKIP_OS_CHECK: "true"

    - name: Ensure Pi-hole admin password is set
      ansible.builtin.command: "pihole setpassword {{ pihole.admin_password }}"
      changed_when: false

    # - name: Wait for Pi-hole API to respond
    #   ansible.builtin.uri:
    #     url: "http://{{ pihole.ssh_host }}/admin/api.php"
    #     method: GET
    #     return_content: false
    #     status_code: 200
    #     validate_certs: false
    #   register: api_probe
    #   retries: 20
    #   delay: 3
    #   until: api_probe.status == 200

    - name: Wait for apt/dpkg locks before installing httpie
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock >/dev/null 2>&1; do
          sleep 3
        done
      changed_when: false

    - name: Install httpie (avoid lock races)
      ansible.builtin.apt:
        name: httpie
        state: present
        update_cache: yes
        lock_timeout: 300

    - name: Authenticate with Pi-hole API
      ansible.builtin.shell: |
        http --ignore-stdin --verify=no --json POST https://{{ pihole.ssh_host }}/api/auth \
          accept:application/json \
          content-type:application/json \
          password="{{ pihole.admin_password }}"
      register: auth_response

    - name: Extract session ID and CSRF token
      ansible.builtin.set_fact:
        session_id: "{{ auth_response.stdout | from_json | json_query('session.sid') }}"
        csrf_token: "{{ auth_response.stdout | from_json | json_query('session.csrf') }}"

    - name: Debug session_id and csrf_token before DHCP API call
      ansible.builtin.debug:
        msg:
          - "Session ID: {{ session_id }}"
          - "CSRF Token: {{ csrf_token }}"

    - name: Log raw authentication response
      ansible.builtin.debug:
        var: auth_response.stdout

    - name: Log parsed session_id and csrf_token
      ansible.builtin.debug:
        msg:
          - "Parsed Session ID: {{ auth_response.stdout | from_json | json_query('session.sid') }}"
          - "Parsed CSRF Token: {{ auth_response.stdout | from_json | json_query('session.csrf') }}"

    - name: Configure DHCP via API
      ansible.builtin.shell: |
        http --ignore-stdin --verify=no PATCH https://{{ pihole.ssh_host }}/api/config \
          Cookie:"SID={{ session_id }}" \
          X-CSRF-Token:{{ csrf_token }} \
          accept:application/json \
          config:='{
            "dhcp": {
              "active": true,
              "start": "{{ pihole.dhcp.start_ip }}",
              "end": "{{ pihole.dhcp.end_ip }}",
              "router": "{{ pihole.dhcp.router_ip }}",
              "leaseTime": "{{ pihole.dhcp.lease_time }}"
            }
          }'
      register: dhcp_patch_output
      when: session_id is defined and csrf_token is defined

    - name: Display DHCP configuration output
      ansible.builtin.debug:
        var: dhcp_patch_output.stdout | from_json

    - name: Debug session_id and csrf_token before blocklist API call
      ansible.builtin.debug:
        msg:
          - "Session ID: {{ session_id }}"
          - "CSRF Token: {{ csrf_token }}"

    - name: Add blocklists via API
      ansible.builtin.shell: |
        http --ignore-stdin --verify=no POST https://{{ pihole.ssh_host }}/api/lists \
          accept:application/json \
          content-type:application/json \
          Cookie:"SID={{ session_id }}" \
          X-CSRF-Token:{{ csrf_token }} \
          address="{{ item }}" \
          type=block \
          comment="Added via Ansible automation" \
          groups:='[0]' \
          enabled:=true
      loop: "{{ pihole.blocklists }}"
      when: session_id is defined and csrf_token is defined