---
# System Update Playbook
# Updates the underlying OS (Ubuntu/Debian) and performs system maintenance
# Includes security updates and package cleanup

- name: Update Operating System
  hosts: pihole
  become: true
  gather_facts: true
  
  tasks:
    - name: Display current OS information
      debug:
        msg: |
          Operating System: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          Architecture: {{ ansible_architecture }}
    
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_cache_update
    
    - name: Check for available updates
      shell: apt list --upgradable 2>/dev/null | grep -v "^Listing" | wc -l
      register: updates_available
      changed_when: false
    
    - name: Display available updates count
      debug:
        msg: "Available updates: {{ updates_available.stdout }} packages"
    
    - name: List available updates
      shell: apt list --upgradable 2>/dev/null | grep -v "^Listing" | head -20
      register: update_list
      changed_when: false
      when: updates_available.stdout | int > 0
    
    - name: Display update list
      debug:
        msg: |
          Updates available:
          {{ update_list.stdout_lines | default(['No updates']) | join('\n') }}
      when: updates_available.stdout | int > 0
    
    - name: Upgrade all packages (safe upgrade)
      apt:
        upgrade: safe
        autoremove: yes
        autoclean: yes
      register: apt_upgrade
      when: updates_available.stdout | int > 0
    
    - name: Upgrade all packages (full upgrade - includes kernel)
      apt:
        upgrade: full
        autoremove: yes
        autoclean: yes
      register: apt_full_upgrade
      when: 
        - updates_available.stdout | int > 0
        - ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"
    
    - name: Remove unused packages
      apt:
        autoremove: yes
        purge: yes
    
    - name: Clean apt cache
      apt:
        autoclean: yes
    
    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
    
    - name: Display reboot status
      debug:
        msg: |
          System Update Summary:
          - Packages updated: {{ 'Yes' if apt_upgrade.changed or apt_full_upgrade.changed else 'No updates needed' }}
          - Reboot required: {{ 'YES - Please reboot the system' if reboot_required.stat.exists else 'No' }}
          
          {% if reboot_required.stat.exists %}
          To reboot:
          ansible pihole -i inventory/hosts.yml --extra-vars "@.env.yaml" -m reboot -b
          {% endif %}
    
    - name: Display reboot warning
      debug:
        msg: |
          ⚠️  REBOOT REQUIRED ⚠️
          
          A system reboot is required to complete the updates.
          This usually happens after kernel or critical system updates.
          
          To reboot now:
          ansible pihole -i inventory/hosts.yml --extra-vars "@.env.yaml" -m reboot -b
          
          Or manually:
          ssh {{ ansible_user }}@{{ ansible_host }}
          sudo reboot
      when: reboot_required.stat.exists

# Made with Bob