---
# Pi-hole Service Management Tasks
# Manages Pi-hole FTL service and related services

- name: Ensure Pi-hole FTL service is enabled
  systemd:
    name: pihole-FTL
    enabled: yes
  register: pihole_ftl_enabled

- name: Check Pi-hole FTL service status
  systemd:
    name: pihole-FTL
  register: pihole_ftl_status

- name: Display Pi-hole FTL service status
  debug:
    msg: |
      Pi-hole FTL Service Status:
      - State: {{ pihole_ftl_status.status.ActiveState | default('unknown') }}
      - Enabled: {{ pihole_ftl_enabled.enabled | default('unknown') }}
      - Running: {{ pihole_ftl_status.status.SubState | default('unknown') }}

- name: Restart Pi-hole FTL if configuration changed
  systemd:
    name: pihole-FTL
    state: restarted
  when: pihole_config_changed | default(false)
  register: pihole_restart_result

- name: Wait for Pi-hole FTL to be ready after restart
  wait_for:
    port: 53
    host: localhost
    delay: 2
    timeout: 30
  when: pihole_restart_result is changed

- name: Verify Pi-hole DNS is responding
  command: dig @localhost google.com +short
  register: dns_check
  changed_when: false
  failed_when: dns_check.rc != 0
  retries: 3
  delay: 5

- name: Display DNS check result
  debug:
    msg: |
      DNS Service Check:
      - Status: {{ 'PASSED' if dns_check.stdout else 'FAILED' }}
      - Response: {{ dns_check.stdout | default('No response') }}

- name: Check if web interface is accessible
  uri:
    url: "http://localhost/admin/"
    method: GET
    status_code: 200
  register: web_check
  failed_when: false
  become: false

- name: Display web interface status
  debug:
    msg: |
      Web Interface Status:
      - Accessible: {{ 'Yes' if web_check.status == 200 else 'No' }}
      - Status Code: {{ web_check.status | default('N/A') }}

- name: Create Pi-hole status check script
  copy:
    content: |
      #!/bin/bash
      # Pi-hole Status Check Script
      # Generated by Ansible
      
      echo "=== Pi-hole Service Status ==="
      systemctl status pihole-FTL --no-pager
      echo
      
      echo "=== Pi-hole Version ==="
      pihole version
      echo
      
      echo "=== DNS Service Check ==="
      dig @localhost google.com +short | head -1
      echo
      
      echo "=== Web Interface Check ==="
      curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost/admin/
      echo
      
      echo "=== Pi-hole Statistics ==="
      pihole -c -e
    dest: /usr/local/bin/pihole-status
    owner: root
    group: root
    mode: '0755'

- name: Display service management summary
  debug:
    msg: |
      Pi-hole Service Management Complete:
      - FTL Service: {{ pihole_ftl_status.status.ActiveState | default('unknown') }}
      - DNS Port 53: Listening
      - Web Interface: {{ 'Accessible' if web_check.status == 200 else 'Check manually' }}
      - Status Script: /usr/local/bin/pihole-status

# Made with Bob
