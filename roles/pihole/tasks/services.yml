---
# Pi-hole Service Management Tasks
# Manages Pi-hole services and ensures they're running properly

- name: Ensure Pi-hole-FTL service is enabled and started
  systemd:
    name: pihole-FTL
    enabled: true
    state: started
    daemon_reload: true
  register: pihole_service

- name: Check Pi-hole-FTL service status
  systemd:
    name: pihole-FTL
  register: pihole_ftl_status

- name: Display Pi-hole-FTL service status
  debug:
    msg: |
      Pi-hole-FTL Service Status:
      - Active: {{ pihole_ftl_status.status.ActiveState }}
      - Enabled: {{ pihole_ftl_status.status.UnitFileState }}
      - Running since: {{ pihole_ftl_status.status.ActiveEnterTimestamp | default('N/A') }}

# Lighttpd is not needed when using Pi-hole FTL built-in web server

- name: Check if Pi-hole is responding to DNS queries
  command: dig @localhost google.com
  register: dns_test
  changed_when: false
  failed_when: false

- name: Display DNS test result
  debug:
    msg: |
      DNS Test Result: {{ 'PASSED' if dns_test.rc == 0 else 'FAILED' }}
      {% if dns_test.rc != 0 %}
      Error: {{ dns_test.stderr | default('Unknown error') }}
      {% endif %}

- name: Test Pi-hole blocking functionality
  command: dig @localhost doubleclick.net
  register: block_test
  changed_when: false
  failed_when: false

- name: Display blocking test result
  debug:
    msg: |
      Blocking Test Result: {{ 'PASSED (domain blocked)' if '0.0.0.0' in block_test.stdout else 'NEEDS_REVIEW' }}
      Response: {{ block_test.stdout_lines[0] if block_test.stdout_lines else 'No response' }}

- name: Ensure Pi-hole log rotation is configured
  copy:
    content: |
      /var/log/pihole.log {
          daily
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
          create 0644 pihole pihole
          postrotate
              /usr/bin/killall -SIGUSR1 pihole-FTL
          endscript
      }
    dest: /etc/logrotate.d/pihole
    owner: root
    group: root
    mode: '0644'

- name: Create Pi-hole status check script
  copy:
    content: |
      #!/bin/bash
      # Pi-hole Status Check Script
      # Generated by Ansible
      
      echo "=== Pi-hole Status Check ==="
      echo "Date: $(date)"
      echo
      
      echo "=== Service Status ==="
      systemctl is-active pihole-FTL
      systemctl is-enabled pihole-FTL
      echo
      
      echo "=== DNS Test ==="
      dig @localhost google.com +short
      echo
      
      echo "=== Blocking Test ==="
      dig @localhost doubleclick.net +short
      echo
      
      echo "=== Pi-hole Status ==="
      pihole status
      echo
      
      echo "=== Recent Queries (last 10) ==="
      tail -10 /var/log/pihole.log
    dest: /usr/local/bin/pihole-status
    owner: root
    group: root
    mode: '0755'

- name: Create Pi-hole update script
  copy:
    content: |
      #!/bin/bash
      # Pi-hole Update Script
      # Generated by Ansible
      
      echo "=== Pi-hole Update ==="
      echo "Date: $(date)"
      echo
      
      echo "=== Updating Pi-hole ==="
      pihole -up
      echo
      
      echo "=== Updating Gravity ==="
      pihole -g
      echo
      
      echo "=== Status Check ==="
      pihole status
    dest: /usr/local/bin/pihole-update
    owner: root
    group: root
    mode: '0755'

- name: Create DHCP validation script (if DHCP is enabled)
  copy:
    content: |
      #!/bin/bash
      # Pi-hole DHCP Validation Script
      # Generated by Ansible
      
      echo "=== Pi-hole DHCP Status Check ==="
      echo "Date: $(date)"
      echo
      
      echo "=== Pi-hole Status ==="
      pihole status
      echo
      
      echo "=== DNSmasq Process Check ==="
      ps aux | grep dnsmasq | grep -v grep || echo "No dnsmasq processes found"
      echo
      
      echo "=== DHCP Configuration ==="
      if [ -f /etc/dnsmasq.d/04-pihole-dhcp.conf ]; then
        echo "DHCP config file (/etc/dnsmasq.d/04-pihole-dhcp.conf):"
        cat /etc/dnsmasq.d/04-pihole-dhcp.conf
      elif grep -q "DHCP_ACTIVE=true" /etc/pihole/setupVars.conf 2>/dev/null; then
        echo "DHCP settings in setupVars.conf:"
        grep DHCP /etc/pihole/setupVars.conf
      else
        echo "DHCP configuration not found or disabled"
      fi
      echo
      
      echo "=== DHCP Lease Files ==="
      for lease_file in /var/lib/dhcp/dhcpd.leases /etc/pihole/dhcp.leases; do
        if [ -f "$lease_file" ]; then
          echo "Lease file $lease_file exists ($(wc -l < "$lease_file") entries)"
          echo "Recent leases:"
          tail -20 "$lease_file"
        else
          echo "Lease file $lease_file not found"
        fi
      done
      echo
      
      echo "=== Network Interface Status ==="
      ip addr show {{ pihole_interface | default('eth0') }}
      echo
      
      echo "=== DHCP Range Test ==="
      echo "Configured DHCP range: {{ pihole_dhcp_start | default('Not configured') }} - {{ pihole_dhcp_end | default('Not configured') }}"
      echo "Gateway: {{ pihole_dhcp_router | default('Not configured') }}"
      echo "Lease time: {{ pihole_dhcp_lease_time | default('Not configured') }}"
    dest: /usr/local/bin/pihole-dhcp-check
    owner: root
    group: root
    mode: '0755'
  when: pihole_dhcp_enabled | default(false) | bool