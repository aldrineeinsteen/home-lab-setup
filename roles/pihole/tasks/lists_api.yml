---
# Pi-hole List Management - Modern FTL API v6+
# Uses official Pi-hole FTL API with session-based authentication
# API Documentation: https://ftl.pi-hole.net/master/docs/

- name: Authenticate with Pi-hole FTL API
  uri:
    url: "http://localhost/api/auth"
    method: POST
    headers:
      accept: "application/json"
      content-type: "application/json"
    body_format: json
    body:
      password: "{{ pihole_admin_password }}"
    return_content: true
    status_code: 200
  register: pihole_auth
  changed_when: false
  failed_when: not pihole_auth.json.session.valid

- name: Display authentication status
  debug:
    msg: "Pi-hole API Authentication: {{ 'SUCCESS' if pihole_auth.json.session.valid else 'FAILED' }}"

- name: Set session variables
  set_fact:
    pihole_session_id: "{{ pihole_auth.json.session.sid }}"
    pihole_csrf_token: "{{ pihole_auth.cookies.get('CSRF_TOKEN', '') }}"
  when: pihole_auth.json.session.valid

- name: Get existing adlists first
  uri:
    url: "http://localhost/api/lists?type=block"
    method: GET
    headers:
      accept: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    return_content: true
  register: existing_adlists
  changed_when: false
  failed_when: false
  when: pihole_auth.json.session.valid

- name: Add adlists using FTL API v6+ (POST /api/lists) - only if not exists
  uri:
    url: "http://localhost/api/lists"
    method: POST
    headers:
      accept: "application/json"
      content-type: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    body_format: json
    body:
      address: "{{ item }}"
      type: "block"
      comment: "Added via Ansible automation"
      groups: [0]
      enabled: true
    return_content: true
    status_code: [200, 201, 409]  # 409 = Conflict (already exists)
  register: add_adlist_result
  loop: "{{ pihole_blocklists | default([]) }}"
  changed_when: add_adlist_result.status == 201
  failed_when: add_adlist_result.status not in [200, 201, 409]
  when: 
    - pihole_auth.json.session.valid
    - pihole_blocklists is defined 
    - pihole_blocklists | length > 0
    - existing_adlists.json is defined
    - item not in (existing_adlists.json.lists | default([]) | selectattr('address', 'defined') | map(attribute='address') | list)

- name: Get existing whitelist first
  uri:
    url: "http://localhost/api/lists?type=allow"
    method: GET
    headers:
      accept: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    return_content: true
  register: existing_whitelist
  changed_when: false
  failed_when: false
  when: pihole_auth.json.session.valid

- name: Add domains to whitelist using FTL API v6+ (POST /api/lists) - only if not exists
  uri:
    url: "http://localhost/api/lists"
    method: POST
    headers:
      accept: "application/json"
      content-type: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    body_format: json
    body:
      address: "{{ item }}"
      type: "allow"
      comment: "Whitelisted via Ansible automation"
      groups: [0]
      enabled: true
    return_content: true
    status_code: [200, 201, 409]  # 409 = Conflict (already exists)
  register: add_whitelist_result
  loop: "{{ pihole_whitelist | default([]) }}"
  changed_when: add_whitelist_result.status == 201
  failed_when: add_whitelist_result.status not in [200, 201, 409]
  when: 
    - pihole_auth.json.session.valid
    - pihole_whitelist is defined 
    - pihole_whitelist | length > 0
    - existing_whitelist.json is defined
    - item not in (existing_whitelist.json.lists | default([]) | selectattr('address', 'defined') | map(attribute='address') | list)

- name: Get existing blacklist first  
  uri:
    url: "http://localhost/api/lists?type=block"
    method: GET
    headers:
      accept: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    return_content: true
  register: existing_blacklist
  changed_when: false
  failed_when: false
  when: pihole_auth.json.session.valid

- name: Add domains to blacklist using FTL API v6+ (POST /api/lists) - only if not exists
  uri:
    url: "http://localhost/api/lists"
    method: POST
    headers:
      accept: "application/json"
      content-type: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    body_format: json
    body:
      address: "{{ item }}"
      type: "block"
      comment: "Blacklisted via Ansible automation"
      groups: [0]
      enabled: true
    return_content: true
    status_code: [200, 201, 409]  # 409 = Conflict (already exists)
  register: add_blacklist_result
  loop: "{{ pihole_blacklist | default([]) }}"
  changed_when: add_blacklist_result.status == 201
  failed_when: add_blacklist_result.status not in [200, 201, 409]
  when: 
    - pihole_auth.json.session.valid
    - pihole_blacklist is defined 
    - pihole_blacklist | length > 0
    - existing_blacklist.json is defined
    - item not in (existing_blacklist.json.lists | default([]) | selectattr('address', 'defined') | map(attribute='address') | list)

- name: Get all lists to verify additions
  uri:
    url: "http://localhost/api/lists"
    method: GET
    headers:
      accept: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    return_content: true
  register: all_lists
  changed_when: false
  failed_when: false
  when: pihole_auth.json.session.valid

- name: Update gravity (process all lists) using FTL API - only if lists were added
  uri:
    url: "http://localhost/api/gravity"
    method: POST
    headers:
      accept: "application/json"
      content-type: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    body_format: json
    body: {}
    return_content: true
    timeout: 120
    status_code: [200, 204]
  register: gravity_update
  changed_when: gravity_update.status in [200, 204]
  failed_when: false
  when: 
    - pihole_auth.json.session.valid
    - (add_adlist_result.changed | default(false)) or 
      (add_whitelist_result.changed | default(false)) or 
      (add_blacklist_result.changed | default(false))

- name: Get updated statistics using FTL API
  uri:
    url: "http://localhost/api/stats"
    method: GET
    headers:
      accept: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    return_content: true
  register: pihole_stats
  changed_when: false
  failed_when: false
  when: 
    - pihole_auth.json.session.valid
    - gravity_update is succeeded

- name: Display list management results
  debug:
    msg: |
      Modern Pi-hole FTL API v6+ Results:
      ===================================
      Authentication: {{ 'SUCCESS' if pihole_auth.json.session.valid else 'FAILED' }}
      Adlists Added: {{ pihole_blocklists | length if pihole_blocklists is defined else 0 }} configured
      Whitelist Added: {{ pihole_whitelist | length if pihole_whitelist is defined else 0 }} domains
      Blacklist Added: {{ pihole_blacklist | length if pihole_blacklist is defined else 0 }} domains
      Total Lists in System: {{ all_lists.json | length if all_lists.json is defined else 'Unknown' }}
      Block Lists: {{ (all_lists.json | selectattr('type', 'equalto', 'block') | list | length) if all_lists.json is defined else 'Unknown' }}
      Allow Lists: {{ (all_lists.json | selectattr('type', 'equalto', 'allow') | list | length) if all_lists.json is defined else 'Unknown' }}
      Gravity Update: {{ 'SUCCESS' if gravity_update.changed else 'NO CHANGES' }}
      Session ID: {{ pihole_session_id | default('Not available') }}
      Total Blocked Domains: {{ pihole_stats.json.blocked_domains | default('Unknown') }}
      DNS Queries Today: {{ pihole_stats.json.queries_today | default('Unknown') }}
      ===================================

- name: Logout from Pi-hole session (cleanup)
  uri:
    url: "http://localhost/api/auth"
    method: DELETE
    headers:
      accept: "application/json"
      cookie: "sid={{ pihole_session_id }}; CSRF_TOKEN={{ pihole_csrf_token }}"
    return_content: true
  register: logout_result
  changed_when: false
  failed_when: false
  when: 
    - pihole_auth.json.session.valid
    - pihole_session_id is defined